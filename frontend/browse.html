<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browse - Sugar Dating</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <h2>Browse Sugar Mummy Profiles</h2>

  <div id="profiles"></div>

  <div id="upgradeDiv">
    <button id="upgradeBtn">Upgrade to Premium</button>
    <p id="upgradeMessage"></p>
  </div>

  <button onclick="window.location.href='profile.html'">My Profile</button>
  <button onclick="logout()">Logout</button>
</div>

<script>
const token = localStorage.getItem("token");
let user = JSON.parse(localStorage.getItem("user"));
if(!token) window.location.href="login.html";

const profilesContainer = document.getElementById("profiles");
const upgradeBtn = document.getElementById("upgradeBtn");
const upgradeMessage = document.getElementById("upgradeMessage");

function updateUpgradeDisplay(){
  if(user.premium){
    upgradeBtn.style.display = "none";
    upgradeMessage.innerText = "You are a premium user.";
  } else if(user.pendingUpgrade){
    upgradeBtn.style.display = "none";
    upgradeMessage.innerText = "Your upgrade request is pending confirmation.";
  } else {
    upgradeBtn.style.display = "inline-block";
    upgradeMessage.innerText = "";
  }
}
updateUpgradeDisplay();

// Load profiles
async function loadProfiles(){
  try{
    const res = await fetch("https://sugar-dating-site.onrender.com/api/users", {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();
    if(data.error){ profilesContainer.innerHTML=`<p>${data.error}</p>`; return; }
    if(data.length===0){ profilesContainer.innerHTML="<p>No profiles available.</p>"; return; }

    profilesContainer.innerHTML = data.map(u=>`
      <div class="profile-card">
        <img src="${u.image || 'https://via.placeholder.com/150'}" alt="${u.name}" width="150" height="150">
        <h3>${u.name}</h3>
        <p>DOB: ${u.dateOfBirth}</p>
        ${user.premium ? `<button onclick="startChat('${u.email}','${u.name}')">Chat</button>` : "<p>Premium only</p>"}
      </div>
    `).join("");
  }catch(err){
    console.log(err);
    profilesContainer.innerHTML="<p>Network error.</p>";
  }
}
window.onload = loadProfiles;

// Chat function (premium only)
function startChat(email,name){
  if(!user.premium){
    alert("Only premium users can chat with sugar mummies.");
    return;
  }
  alert(`Starting chat with ${name} (${email})\n(Chat system can be integrated later)`);
}

// Manual Upgrade
upgradeBtn.addEventListener("click", async ()=>{
  const confirmPayment = confirm(
    "To upgrade to Premium, please pay 5,000 Naira to 2035470745, Kuda MFB.\nClick OK once payment is completed."
  );
  if(!confirmPayment) return;

  try{
    const res = await fetch(`https://sugar-dating-site.onrender.com/api/users/request-upgrade/${user.email}`,{
      method:"POST",
      headers:{ "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();
    upgradeMessage.innerText = data.message || data.error;
    if(data.message){
      user.pendingUpgrade=true;
      localStorage.setItem("user", JSON.stringify(user));
      updateUpgradeDisplay();
    }
  }catch{
    upgradeMessage.innerText="Network error. Try again.";
  }
});

// Logout
function logout(){
  localStorage.removeItem("token");
  localStorage.removeItem("user");
  window.location.href="login.html";
}
</script>
</body>
</html>
